DELIMITER //

Create or Replace Procedure usp_COMP_01_03_Packet(
	 IN V_COMP_ID VARCHAR(20)
	,IN V_DUST_FILTER_CLN			VARCHAR(20)
	,IN V_INHALATE_FILTER_CHG		VARCHAR(20)
	,IN V_OIL_FILTER_CHG			VARCHAR(20)
	,IN V_LUBRICATING_OIL_CHG		VARCHAR(20)
	,IN V_COOLER_INSPECT			VARCHAR(20)
	,IN V_DISASSEMBLE_INSPECT		VARCHAR(20)
	,IN V_CUR_DUST_FILTER_CLN		VARCHAR(20)
	,IN V_CUR_INHALATE_FILTER_CHG		VARCHAR(20)
	,IN V_CUR_OIL_FILTER_CHG		VARCHAR(20)
	,IN V_CUR_LUBRICATING_OIL_CHG		VARCHAR(20)
	,IN V_CUR_COOLER_INSPECT		VARCHAR(20)
	,IN V_CUR_DISASSEMBLE_INSPECT		VARCHAR(20)
	,IN V_SAVE_TIME_STR VARCHAR(20)
	,OUT V_RESULT INT
)
Begin
/*
@description
-- 1-3번 패킷을 받아서, COMP정보에 조회하고
-- 있다면 TBM_COMP_AS 테이블에 저장하고, 이력을 TBP_COMP_AS 테이블에 저장
@param
@return : 정보가 있다면 1, 없다면 0 , Error : -1
*/
DECLARE recordCnt INT DEFAULT 0;

DECLARE exit handler for SQLEXCEPTION
BEGIN
	ROLLBACK;
	SET V_RESULT = -1;
	SELECT 'An error has occurred, operation rollbacked';
END;

SELECT 
	Count(*) INTO recordCnt
FROM TBM_COMPRESSOR
WHERE COMP_ID = V_COMP_ID AND REGIST_YN = 'Y';

-- 해당하는 값이 없다면 RETURN
IF recordCnt < 1 THEN
	SET V_RESULT = 0;
ELSE
BEGIN
	
	IF NOT EXISTS (SELECT * FROM TBM_COMP_AS WHERE COMP_ID = V_COMP_ID) THEN
		INSERT INTO TBM_COMP_AS(COMP_ID,SAVE_TIME_STR, DUST_FILTER_CLN, INHALATE_FILTER_CHG, OIL_FILTER_CHG, LUBRICATING_OIL_CHG ,COOLER_INSPECT , DISASSEMBLE_INSPECT ,CUR_DUST_FILTER_CLN ,CUR_INHALATE_FILTER_CHG , CUR_OIL_FILTER_CHG ,CUR_LUBRICATING_OIL_CHG , CUR_COOLER_INSPECT ,CUR_DISASSEMBLE_INSPECT) VALUES(V_COMP_ID, V_SAVE_TIME_STR, V_DUST_FILTER_CLN, V_INHALATE_FILTER_CHG, V_OIL_FILTER_CHG, V_LUBRICATING_OIL_CHG , V_COOLER_INSPECT , V_DISASSEMBLE_INSPECT , V_CUR_DUST_FILTER_CLN , V_CUR_INHALATE_FILTER_CHG , V_CUR_OIL_FILTER_CHG , V_CUR_LUBRICATING_OIL_CHG , V_CUR_COOLER_INSPECT , V_CUR_DISASSEMBLE_INSPECT);
	ELSE
		UPDATE TBM_COMP_AS
		SET
			SAVE_TIME_STR = V_SAVE_TIME_STR
			, DUST_FILTER_CLN = V_DUST_FILTER_CLN		
			, INHALATE_FILTER_CHG = V_INHALATE_FILTER_CHG	
			, OIL_FILTER_CHG = V_OIL_FILTER_CHG		
			, LUBRICATING_OIL_CHG = V_LUBRICATING_OIL_CHG	
			, COOLER_INSPECT = V_COOLER_INSPECT		
			, DISASSEMBLE_INSPECT = V_DISASSEMBLE_INSPECT	
			, CUR_DUST_FILTER_CLN = V_CUR_DUST_FILTER_CLN	
			, CUR_INHALATE_FILTER_CHG = V_CUR_INHALATE_FILTER_CHG
			, CUR_OIL_FILTER_CHG = V_CUR_OIL_FILTER_CHG	
			, CUR_LUBRICATING_OIL_CHG = V_CUR_LUBRICATING_OIL_CHG
			, CUR_COOLER_INSPECT = V_CUR_COOLER_INSPECT	
			, CUR_DISASSEMBLE_INSPECT = V_CUR_DISASSEMBLE_INSPECT
		WHERE COMP_ID = V_COMP_ID;
	END IF;

	-- TBP  테이블에는 이력이 없을때만 저장해서, 동일한 이력이 발생하지 않도록 한다.
	IF NOT EXISTS (SELECT * FROM TBP_COMP_AS WHERE COMP_ID = V_COMP_ID AND SAVE_TIME_STR = V_SAVE_TIME_STR) THEN
		INSERT INTO TBP_COMP_AS(COMP_ID, SAVE_TIME_STR, DUST_FILTER_CLN, INHALATE_FILTER_CHG, OIL_FILTER_CHG, LUBRICATING_OIL_CHG ,COOLER_INSPECT , DISASSEMBLE_INSPECT ,CUR_DUST_FILTER_CLN ,CUR_INHALATE_FILTER_CHG , CUR_OIL_FILTER_CHG ,CUR_LUBRICATING_OIL_CHG , CUR_COOLER_INSPECT ,CUR_DISASSEMBLE_INSPECT)
		SELECT COMP_ID, SAVE_TIME_STR, DUST_FILTER_CLN, INHALATE_FILTER_CHG, OIL_FILTER_CHG, LUBRICATING_OIL_CHG ,COOLER_INSPECT , DISASSEMBLE_INSPECT ,CUR_DUST_FILTER_CLN ,CUR_INHALATE_FILTER_CHG , CUR_OIL_FILTER_CHG ,CUR_LUBRICATING_OIL_CHG , CUR_COOLER_INSPECT ,CUR_DISASSEMBLE_INSPECT
		FROM TBM_COMP_AS WHERE COMP_ID = V_COMP_ID;
	END IF;

	SET V_RESULT = 1;
END;	
END IF;

COMMIT;

END
//

DELIMITER ;