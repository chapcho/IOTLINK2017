DELIMITER //

Create or Replace Procedure usp_COMP_01_01_Packet(
	 IN V_COMP_ID VARCHAR(20)
	,IN V_UNLOAD_OPER_PRESS VARCHAR(20) -- 무부하운전압력
	,IN V_LOAD_OPER_PRESS VARCHAR(20) -- 부하운전압력
	,IN V_AUTO_STOP_DELAY_HOUR VARCHAR(20) -- 자동정지지연시간
	,IN V_MANUAL_STOP_DELAY_HOUR VARCHAR(20) -- 수동정지지연시간
	,IN V_START_DELAY_HOUR_SET VARCHAR(20) -- 기동지연시간설정
	,IN V_DRAIN_OPER_HOUR VARCHAR(20) -- 드레인동작시간
	,IN V_DRAIN_OPER_PERIOD VARCHAR(20) -- 드레인동작주기
	,IN V_COOLING_FAN_START_TEMPER VARCHAR(20) -- 쿨링팬운전온도
	,IN V_COOLING_FAN_STOP_TEMPER VARCHAR(20) -- 쿨링팬정지온도
	,IN V_SAVE_TIME_STR VARCHAR(20),
	OUT V_RESULT INT
)
Begin
/*


@description
-- 1-1번 패킷을 받아서, COMP정보에 조회하고
-- 있다면 TBM_COMP_SET 테이블에 저장하고, 이력을 TBP_COMP_SET 테이블에 저장
@param
@return : 정보가 있다면 1, 없다면 0 , Error : -1
*/
DECLARE recordCnt INT DEFAULT 0;

DECLARE exit handler for SQLEXCEPTION
BEGIN
	ROLLBACK;
	SET V_RESULT = -1;
	SELECT 'An error has occurred, operation rollbacked';
END;

SELECT 
	Count(*) INTO recordCnt
FROM TBM_COMPRESSOR
WHERE COMP_ID = V_COMP_ID AND REGIST_YN = 'Y';

-- 해당하는 값이 없다면 RETURN
IF recordCnt < 1 THEN
	SET V_RESULT = 0;
ELSE
BEGIN
	
	IF NOT EXISTS (SELECT * FROM TBM_COMP_SET WHERE COMP_ID = V_COMP_ID) THEN
		INSERT INTO TBM_COMP_SET(COMP_ID, SAVE_TIME_STR, UNLOAD_OPER_PRESS, LOAD_OPER_PRESS, AUTO_STOP_DELAY_HOUR , MANUAL_STOP_DELAY_HOUR, START_DELAY_HOUR_SET , DRAIN_OPER_HOUR , DRAIN_OPER_PERIOD , COOLING_FAN_START_TEMPER , COOLING_FAN_STOP_TEMPER) VALUES(V_COMP_ID, V_SAVE_TIME_STR, V_UNLOAD_OPER_PRESS, V_LOAD_OPER_PRESS, V_AUTO_STOP_DELAY_HOUR , V_MANUAL_STOP_DELAY_HOUR, V_START_DELAY_HOUR_SET , V_DRAIN_OPER_HOUR , V_DRAIN_OPER_PERIOD , V_COOLING_FAN_START_TEMPER , V_COOLING_FAN_STOP_TEMPER);
	ELSE
		UPDATE TBM_COMP_SET
		SET
			SAVE_TIME_STR = V_SAVE_TIME_STR
			, UNLOAD_OPER_PRESS = V_UNLOAD_OPER_PRESS
			, LOAD_OPER_PRESS = V_LOAD_OPER_PRESS
			, AUTO_STOP_DELAY_HOUR  = V_AUTO_STOP_DELAY_HOUR
			, MANUAL_STOP_DELAY_HOUR = V_MANUAL_STOP_DELAY_HOUR
			, START_DELAY_HOUR_SET  = V_START_DELAY_HOUR_SET
			, DRAIN_OPER_HOUR  = V_DRAIN_OPER_HOUR
			, DRAIN_OPER_PERIOD = V_DRAIN_OPER_PERIOD
			, COOLING_FAN_START_TEMPER  = V_COOLING_FAN_START_TEMPER
			, COOLING_FAN_STOP_TEMPER = V_COOLING_FAN_STOP_TEMPER
		WHERE COMP_ID = V_COMP_ID;
	END IF;

	-- TBP  테이블에는 이력이 없을때만 저장해서, 동일한 이력이 발생하지 않도록 한다.
	IF NOT EXISTS (SELECT * FROM TBP_COMP_SET WHERE COMP_ID = V_COMP_ID AND SAVE_TIME_STR = V_SAVE_TIME_STR) THEN
		INSERT INTO TBP_COMP_SET(COMP_ID, SAVE_TIME_STR, UNLOAD_OPER_PRESS, LOAD_OPER_PRESS ,AUTO_STOP_DELAY_HOUR, MANUAL_STOP_DELAY_HOUR , START_DELAY_HOUR_SET, DRAIN_OPER_HOUR , DRAIN_OPER_PERIOD , COOLING_FAN_START_TEMPER , COOLING_FAN_STOP_TEMPER , SUN_OPER_PERIOD ,MON_OPER_PERIOD ,TUE_OPER_PERIOD , WED_OPER_PERIOD  ,THU_OPER_PERIOD  , FRI_OPER_PERIOD , SAT_OPER_PERIOD ,YD_TRANS_RODE_HOUR , LOAD_OPER_HOUR , RELOAD_OPER_DELAY , DIFF_PRESS_DETECT_DELAY , LOAD_OPER_MODE_SET ,START_MODE_SET , POWER_CUT_RETURN_SET , SERVER_ADDR , COMM_SPEED , DISCHARGE_TEMPER_ULIMIT , DISCHARGE_PRESS_ULIMIT ,OILSKIMMER_TEMPER_ULIMIT , OILSKIMMER_PRESS_ULIMIT , DIFF_PRESS_ULIMIT , ALARM_DISCHARGE_TEMPER_ULIMIT ,ALARM_DISCHARGE_PRESS_ULIMIT ,ALARM_OILSKIMMER_TEMPER_ULIMIT ,ALARM_OILSKIMMER_PRESS_ULIMIT ,ALARM_DIFF_PRESS_ULIMIT ,ALARM_OUT_TEMPER_ULIMIT ,OPER_DISCHARGE_TEMPER_LLIMIT ,OPER_OILSKIMMER_PRESS_ULIMIT)
		SELECT COMP_ID, SAVE_TIME_STR, UNLOAD_OPER_PRESS, LOAD_OPER_PRESS ,AUTO_STOP_DELAY_HOUR, MANUAL_STOP_DELAY_HOUR , START_DELAY_HOUR_SET,DRAIN_OPER_HOUR , DRAIN_OPER_PERIOD , COOLING_FAN_START_TEMPER , COOLING_FAN_STOP_TEMPER , SUN_OPER_PERIOD ,MON_OPER_PERIOD ,TUE_OPER_PERIOD , WED_OPER_PERIOD  ,THU_OPER_PERIOD  , FRI_OPER_PERIOD , SAT_OPER_PERIOD ,YD_TRANS_RODE_HOUR , LOAD_OPER_HOUR , RELOAD_OPER_DELAY , DIFF_PRESS_DETECT_DELAY , LOAD_OPER_MODE_SET ,START_MODE_SET , POWER_CUT_RETURN_SET , SERVER_ADDR , COMM_SPEED , DISCHARGE_TEMPER_ULIMIT , DISCHARGE_PRESS_ULIMIT ,OILSKIMMER_TEMPER_ULIMIT , OILSKIMMER_PRESS_ULIMIT , DIFF_PRESS_ULIMIT , ALARM_DISCHARGE_TEMPER_ULIMIT ,ALARM_DISCHARGE_PRESS_ULIMIT ,ALARM_OILSKIMMER_TEMPER_ULIMIT ,ALARM_OILSKIMMER_PRESS_ULIMIT ,ALARM_DIFF_PRESS_ULIMIT ,ALARM_OUT_TEMPER_ULIMIT ,OPER_DISCHARGE_TEMPER_LLIMIT ,OPER_OILSKIMMER_PRESS_ULIMIT
		FROM TBM_COMP_SET WHERE COMP_ID = V_COMP_ID;
	END IF;

	SET V_RESULT = 1;
END;	
END IF;

COMMIT;

END
//

DELIMITER ;