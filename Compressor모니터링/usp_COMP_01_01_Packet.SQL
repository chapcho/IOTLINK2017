
DELIMITER //
Create or Replace Procedure usp_COMP_01_01_Packet(
	IN V_COMP_ID VARCHAR(20),
,
	IN V_SAVE_TIME_STR VARCHAR(20),
	OUT V_RESULT INT
)
Begin
/*
@description

-- 1-1번 패킷을 받아서, COMP정보에 조회하고
-- 있다면 TBM_COMP_STATUS 테이블에 저장하고, 이력을 TBP_COMP_STATUS 테이블에 저장
@param
@return : 정보가 있다면 1, 없다면 0 , Error : -1
*/
DECLARE recordCnt INT DEFAULT 0;

DECLARE exit handler for SQLEXCEPTION
BEGIN
	ROLLBACK;
	SET V_RESULT = -1;
	SELECT 'An error has occurred, operation rollbacked';
END;

SELECT 
	Count(*) INTO recordCnt
FROM TBM_COMPRESSOR
WHERE COMP_ID = V_COMP_ID AND REGIST_YN = 'Y';

-- 해당하는 값이 없다면 RETURN
IF recordCnt < 1 THEN
	SET V_RESULT = 0;
ELSE
BEGIN
	
	IF NOT EXISTS (SELECT * FROM TBM_COMP_STATUS WHERE COMP_ID = V_COMP_ID) THEN
		INSERT INTO TBM_COMP_STATUS(COMP_ID, SAVE_TIME_STR,CREATE_TIME,UPDATE_TIME) SELECT V_COMP_ID, V_SAVE_TIME_STR, getSaveTimeStr(),getSaveTimeStr() FROM DUAL;
	END IF;
	

	UPDATE TBM_COMP_STATUS
	SET
		SAVE_TIME_STR = V_SAVE_TIME_STR,
		UPDATE_TIME = getSaveTimeStr()
	WHERE COMP_ID = V_COMP_ID;


	IF NOT EXISTS (SELECT * FROM TBP_COMP_STATUS WHERE COMP_ID = V_COMP_ID AND SAVE_TIME_STR = V_SAVE_TIME_STR) THEN
		INSERT INTO TBP_COMP_STATUS(COMP_ID, SAVE_TIME_STR, DISCHARGE_TEMPER, DISCHARGE_PRESS, OUT_TEMPER, OILSKIMMER_PRESS, OILSKIMMER_TEMPER, OILSKIMMER_DIFF_PRESS, TOT_OPER_HOUR,MOTOR_OPER_HOUR, MOTOR_OPER_CNT, LOAD_OPER_HOUR, LOAD_OPER_CNT, INVERTER_CNTL_OUTPUT, DISCHARGE_PRESS_TRANS, DISCHARGE_TEMPER_TRANS, CREATE_TIME, UPDATE_TIME)
		SELECT COMP_ID, SAVE_TIME_STR, DISCHARGE_TEMPER, DISCHARGE_PRESS, OUT_TEMPER, OILSKIMMER_PRESS, OILSKIMMER_TEMPER, OILSKIMMER_DIFF_PRESS, TOT_OPER_HOUR,MOTOR_OPER_HOUR, MOTOR_OPER_CNT, LOAD_OPER_HOUR, LOAD_OPER_CNT, INVERTER_CNTL_OUTPUT, DISCHARGE_PRESS_TRANS, DISCHARGE_TEMPER_TRANS, CREATE_TIME, UPDATE_TIME
		FROM TBM_COMP_STATUS WHERE COMP_ID = V_COMP_ID;
	END IF;


	SET V_RESULT = 1;
END;	
END IF;

COMMIT;

END
//

DELIMITER ;
