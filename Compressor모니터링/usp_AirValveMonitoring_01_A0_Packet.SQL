DELIMITER //

CREATE PROCEDURE usp_AirValveMonitoring_01_A0_Packet(
	  IN V_COMP_ID VARCHAR(20)
	, IN V_VALVE_STATE VARCHAR(20)
	, IN V_HW_VERSION VARCHAR(20)
	, IN V_SW_VERSION VARCHAR(20)
	, IN V_AIR_PRESSURE VARCHAR(20)
	, IN V_CONTROL_STATE VARCHAR(20)
	, IN V_SAVE_TIME_STR VARCHAR(20)
	, OUT V_RESULT INT
)
	LANGUAGE SQL
	NOT DETERMINISTIC
	CONTAINS SQL
	SQL SECURITY DEFINER
	COMMENT '에어벨브 상태를 저장하는 프로시져'
Begin
/*
@description

-- 1-A0번 패킷을 받아서, COMP정보에 조회하고
-- 있다면 TBM_COMP_STATUS 테이블에 저장하고, 이력을 TBP_COMP_STATUS 테이블에 저장
@param
@return : 정보가 있다면 1, 없다면 0 , Error : -1
*/
DECLARE recordCnt INT DEFAULT 0;

DECLARE exit handler for SQLEXCEPTION
BEGIN
	GET DIAGNOSTICS CONDITION 1 @p2 = MESSAGE_TEXT;
	SELECT @p2 as Result;
	
	ROLLBACK;
	SET V_RESULT = -1;
END;

SELECT 
	Count(*) INTO recordCnt
FROM TBM_COMPRESSOR
WHERE COMP_ID = V_COMP_ID AND REGIST_YN = 'Y';

-- 해당하는 값이 없다면 RETURN
IF recordCnt < 1 THEN
	SET V_RESULT = 0;
ELSE
BEGIN
	
	IF NOT EXISTS (SELECT * FROM TBM_COMP_STATUS WHERE COMP_ID = V_COMP_ID) THEN
		INSERT INTO TBM_COMP_STATUS(COMP_ID, SAVE_TIME_STR, CREATE_TIME, UPDATE_TIME,VALVE_STATE,HW_VERSION,SW_VERSION,AIR_PRESSURE,CONTROL_STATE) SELECT V_COMP_ID, V_SAVE_TIME_STR, getSaveTimeStr(),getSaveTimeStr(), V_VALVE_STATE, V_HW_VERSION, V_SW_VERSION, V_AIR_PRESSURE, V_CONTROL_STATE FROM DUAL;
	ELSE
		UPDATE TBM_COMP_STATUS
		SET
			VALVE_STATE = V_VALVE_STATE
			,HW_VERSION = V_HW_VERSION
			,SW_VERSION = V_SW_VERSION
			,AIR_PRESSURE = V_AIR_PRESSURE
			,CONTROL_STATE = V_CONTROL_STATE
			,SAVE_TIME_STR = V_SAVE_TIME_STR
			,UPDATE_TIME = getSaveTimeStr()
		WHERE COMP_ID = V_COMP_ID;
	END IF;

	IF NOT EXISTS (SELECT * FROM TBP_COMP_STATUS WHERE COMP_ID = V_COMP_ID AND SAVE_TIME_STR = V_SAVE_TIME_STR) THEN
		INSERT INTO TBP_COMP_STATUS(COMP_ID, SAVE_TIME_STR, DISCHARGE_TEMPER, DISCHARGE_PRESS, OUT_TEMPER, OILSKIMMER_PRESS, OILSKIMMER_TEMPER, OILSKIMMER_DIFF_PRESS, TOT_OPER_HOUR,MOTOR_OPER_HOUR, MOTOR_OPER_CNT, LOAD_OPER_HOUR, LOAD_OPER_CNT, INVERTER_CNTL_OUTPUT, DISCHARGE_PRESS_TRANS, DISCHARGE_TEMPER_TRANS, ALARM_1, ALARM_2, ALARM_3, CREATE_TIME, UPDATE_TIME,VALVE_STATE,HW_VERSION,SW_VERSION,AIR_PRESSURE,CONTROL_STATE)
		SELECT COMP_ID, SAVE_TIME_STR, DISCHARGE_TEMPER, DISCHARGE_PRESS, OUT_TEMPER, OILSKIMMER_PRESS, OILSKIMMER_TEMPER, OILSKIMMER_DIFF_PRESS, TOT_OPER_HOUR,MOTOR_OPER_HOUR, MOTOR_OPER_CNT, LOAD_OPER_HOUR, LOAD_OPER_CNT, INVERTER_CNTL_OUTPUT, DISCHARGE_PRESS_TRANS, DISCHARGE_TEMPER_TRANS, ALARM_1, ALARM_2, ALARM_3, CREATE_TIME, UPDATE_TIME, VALVE_STATE,HW_VERSION,SW_VERSION,AIR_PRESSURE,CONTROL_STATE
		FROM TBM_COMP_STATUS WHERE COMP_ID = V_COMP_ID;
	END IF;

	SET V_RESULT = 1;
END;	
END IF;

COMMIT;

END

//

DELIMITER ;