
DELIMITER //
Create or Replace Procedure usp_COMP_00_Packet(
	IN V_COMP_ID VARCHAR(20),
	IN V_MOBILE_PHONE_NO VARCHAR(20),
	OUT V_RESULT INT
)
Begin
/*
@description
-- 0번 패킷을 받아서, COMP정보에 조회하고
-- 해당 정보가 있다면, 승인 처리하고 인증 시간을 업데이트 한다.
-- 인증된 정보의 이력을 TBP_COMPRESSOR 테이블에 기록한다.
@param
@return : 정보가 있다면 1, 없다면 0 , Error : -1
*/
DECLARE recordCnt INT DEFAULT 0;

DECLARE exit handler for SQLEXCEPTION
BEGIN
	ROLLBACK;
	SET V_RESULT = -1;
	SELECT 'An error has occurred, operation rollbacked';
END;

SELECT 
	Count(*) INTO recordCnt
FROM TBM_COMPRESSOR
WHERE COMP_ID = V_COMP_ID
AND MOBILE_PHONE_NO = V_MOBILE_PHONE_NO;

-- 해당하는 값이 없다면 RETURN
IF recordCnt < 1 THEN
	SET V_RESULT = 0;
ELSE
	UPDATE TBM_COMPRESSOR
		SET 
			REGIST_YN = 'Y'
			, REGIST_TIME = DATE_FORMAT(NOW(),'%Y%m%d%h%i%s')
			, SAVE_TIME_STR = DATE_FORMAT(NOW(),'%Y%m%d%h%i%s')
		WHERE COMP_ID = V_COMP_ID AND MOBILE_PHONE_NO = V_MOBILE_PHONE_NO;
	
	INSERT TBP_COMPRESSOR(COMP_ID,SAVE_TIME_STR,MODEL_NAME,PRODUCT_NUMBER,DEALER_ID,CONSUMER_ID,BARCODE,AFTER_SERVICE_PERIOD,STATUS,PUBLISH_TIME,START_USING_TIME,CREATE_USER,UPDATE_USER,CREATE_TIME,UPDATE_TIME,REGIST_YN,REGIST_TIME,MOBILE_PHONE_NO)
	SELECT 
		COMP_ID,SAVE_TIME_STR,MODEL_NAME,PRODUCT_NUMBER,DEALER_ID,CONSUMER_ID,BARCODE,AFTER_SERVICE_PERIOD,STATUS,PUBLISH_TIME,START_USING_TIME,CREATE_USER,UPDATE_USER,CREATE_TIME,UPDATE_TIME,REGIST_YN,REGIST_TIME,MOBILE_PHONE_NO 
	FROM TBM_COMPRESSOR
	WHERE COMP_ID = V_COMP_ID AND MOBILE_PHONE_NO = V_MOBILE_PHONE_NO;

	SET V_RESULT = 1;
END IF;

COMMIT;
END
//

DELIMITER ;


/* 테스트
CALL usp_COMP_00_Packet('18041101','01064407941',@Result);
SELECT @Result as Rtn;
*/